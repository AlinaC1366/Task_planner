

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" 
  url      = env("DATABASE_URL")
}

//  ENUM-uri
enum TaskStatus {
  OPEN
  PENDING
  COMPLETED
  CLOSED
}

enum UserRole {
  ADMIN
  MANAGER
  EXECUTANT
}

//  MODELE
model User {
  id              String        @id @default(uuid())
  name            String        
  email           String        @unique
  passwordHash    String       
  role            UserRole
  createdAt       DateTime      @default(now())

  // Relație manager-subordonați (Auto-referențială)
  managerId       String?       @map("manager_id")
  manager         User?         @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates    User[]        @relation("ManagerSubordinates")

  // Relații cu Task-uri
  createdTasks    Task[]        @relation("TaskCreator")
  assignedTasks   Task[]        @relation("TaskAssignedTo")

  // Relație cu istoricul modificărilor
  taskHistory     TaskHistory[]

  // Relație cu proiectele gestionate
  managedProjects Project[]

  @@map("users")
}

model Project {
  id          String    @id @default(uuid())
  name        String    
  description String?
  createdAt   DateTime  @default(now())

  managerId   String    @map("manager_id")
  manager     User      @relation(fields: [managerId], references: [id])

  tasks       Task[]

  @@map("projects")
}

model Task {
  id             String      @id @default(uuid())
  title          String      
  description    String?     
  status         TaskStatus
  createdAt      DateTime    @default(now())

  // Relații
  projectId      String      @map("project_id")
  project        Project     @relation(fields: [projectId], references: [id])

  creatorId      String      @map("creator_id")
  creator        User        @relation("TaskCreator", fields: [creatorId], references: [id])

  assignedToId   String?     @map("assigned_to_id")
  assignedTo     User?       @relation("TaskAssignedTo", fields: [assignedToId], references: [id])

  allocatedAt    DateTime?
  completedAt    DateTime?
  closedAt       DateTime?

  historyEntries TaskHistory[]

  @@map("tasks")
}

model TaskHistory {
  id           String     @id @default(uuid())
  oldStatus    TaskStatus
  newStatus    TaskStatus
  changedAt    DateTime   @default(now())

  taskId       String     @map("task_id")
  task         Task       @relation(fields: [taskId], references: [id])

  changedById  String     @map("changed_by_id")
  changedBy    User       @relation(fields: [changedById], references: [id])

  @@map("task_history")
}